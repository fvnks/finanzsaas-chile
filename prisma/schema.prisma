generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("USER") // ADMIN, USER
  allowedSections String[] // Array of section IDs (e.g. 'invoices', 'projects')

  dailyReports DailyReport[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Client {
  id        String   @id @default(uuid())
  rut       String   @unique
  name      String
  email     String?
  phone     String?
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects  Project[]
  invoices  Invoice[]
  documents   Document[]
  requirements DocumentRequirement[]
}

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  status      String   @default("ACTIVE") // ACTIVE, COMPLETED, ARCHIVED
  clientId    String?
  client      Client?  @relation(fields: [clientId], references: [id])
  
  crews       Crew[]
  invoices    Invoice[]
  dailyReports DailyReport[]
  documents   Document[]
  purchaseOrders PurchaseOrder[]
  inventoryMovements InventoryMovement[]
  
  progress    Int      @default(0)
  budget      Float    @default(0)
  address     String?
  startDate   DateTime?
  endDate     DateTime?
  workerIds   String[] // Legacy field, prefer using Crew relations if possible

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CostCenter {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  budget    Float    @default(0)
  
  createAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoices  Invoice[]
}

model Worker {
  id              String   @id @default(uuid())
  rut             String   @unique
  name            String
  role            String?
  specialty       String?
  email           String?
  phone           String?
  experienceYears Int?
  certifications  String[] // Array of strings
  
  crews           Crew[]   @relation("CrewWorkers")


  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Crew {
  id        String   @id @default(uuid())
  name      String
  role      String?
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])
  
  workers   Worker[] @relation("CrewWorkers")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model JobTitle {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Invoice {
  id           String   @id @default(uuid())
  number       String
  date         DateTime
  dueDate      DateTime?
  status       String   @default("DRAFT") // DRAFT, ISSUED, PAID, CANCELLED
  type         String   // SALE, PURCHASE
  emissionType String   // ELECTRONIC, MANUAL
  
  purchaseOrderNumber String?
  dispatchGuideNumber String?
  
  netAmount    Float
  taxAmount    Float    // IVA
  totalAmount  Float
  
  clientId     String?
  client       Client?  @relation(fields: [clientId], references: [id])
  projectId    String?

  project      Project? @relation(fields: [projectId], references: [id])
  costCenterId String?
  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id])
  
  items        InvoiceItem[]

  // Relations for Credit Notes
  relatedInvoiceId String?
  relatedInvoice   Invoice?  @relation("InvoiceRelation", fields: [relatedInvoiceId], references: [id])
  relatedByInvoices Invoice[] @relation("InvoiceRelation")

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model InvoiceItem {
  id          String   @id @default(uuid())
  description String
  quantity    Float
  unitPrice   Float
  total       Float
  
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model DailyReport {
  id        String   @id @default(uuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  date      DateTime
  content   String
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- NEW MODULES ---

model PurchaseOrder {
  id          String   @id @default(uuid())
  number      String   @unique
  provider    String   
  date        DateTime
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED, COMPLETED
  
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])

  items       PurchaseOrderItem[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  description     String
  quantity        Float
  unitPrice       Float
  total           Float
  
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
}

model Document {
  id        String   @id @default(uuid())
  name      String
  url       String   // Path or URL
  type      String   // PDF, IMAGE, ETC
  
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])
  clientId  String?
  client    Client?  @relation(fields: [clientId], references: [id])

  createdAt DateTime @default(now())

  requirementId String?
  requirement   DocumentRequirement? @relation(fields: [requirementId], references: [id])

  status        String   @default("PENDING") // PENDING, APPROVED, REJECTED
}

model DocumentRequirement {
  id          String   @id @default(uuid())
  name        String
  description String?
  
  month       Int?
  year        Int?

  status      String   @default("PENDING") // PENDING, OK
  dueDate     DateTime?

  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  documents   Document[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Material {
  id          String   @id @default(uuid())
  code        String?  @unique
  name        String
  unit        String   // kg, m, unit
  minStock    Float    @default(0)
  currentStock Float   @default(0)
  
  price       Float    @default(0)
  
  movements   InventoryMovement[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model InventoryMovement {
  id          String   @id @default(uuid())
  type        String   // IN, OUT
  quantity    Float
  date        DateTime @default(now())
  description String?
  
  materialId  String
  material    Material @relation(fields: [materialId], references: [id])
  
  projectId   String?
  project     Project? @relation(fields: [projectId], references: [id])
  
  createdAt   DateTime @default(now())
}

model ClientMonthlyInfo {
  id        String   @id @default(uuid())
  
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  month     Int
  year      Int
  
  edpDate   DateTime? // Fecha hoja de ruta EDP

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([clientId, month, year])
}
